# Changelog

## Unreleased
- Initial skeleton layout, routing, and baseline docs.
- Add Playwright local E2E test setup with a starter home page spec.
- Expand Playwright E2E coverage for public pages, auth screens, and auth-required redirects.
- Add seeded auth Playwright E2E flows for logged-in routes and logout.
- Switch Playwright E2E coverage to click-based navigation flows with member role checks.
- Add Tasks and Reports placeholder pages with sidebar navigation coverage.
- Add config bootstrap, env loading, and secure session defaults.
- Add custom router, middleware stubs, and view renderer.
- Add PDO DB helper, migrations runner, and seed data scripts.
- Add auth flows with CSRF protection, verification, and password reset.
- Add RBAC admin screens for roles, permissions, and user role assignment.
- Add admin users list and audit log with event tracking.
- Add uploads module for profile images and attachments.
- Add application logger, rotation, and error handler.
- Add security headers and baseline input helpers.
- Add minimal test harness and core tests.
- Add GitHub Actions deploy workflow for DreamHost releases.
- Prefix environment variables with `THRIFTSTACK_`.
- Add migration failure context to error output.
- Guard migration commits when DDL ends transactions.
- Fix route naming API to avoid duplicate method names.
- Add CI workflow for PHP linting and tests.
- Add Apache rewrite rules for front controller routing.
- Make CI PHP lint fallback when `rg` is unavailable.
- Add AI stars logo in header and favicon.
- Run seeds during deploy to ensure baseline data exists.
- Allow middleware to pass non-Response handler results.
- Update ThriftStack casing in user-facing labels.
- Add prompt-pack plans for workspaces, settings, notifications, analytics, and billing.
- Add sidebar navigation layout.
- Add header account menu and sidebar placeholders for tasks/reports/admin.
- Move dashboard link from header to sidebar.
- Restyle account menu with avatar initials and dropdown indicator.
- Move logout into account menu and add global file input styling.
- Add divider before logout in account menu.
- Make brand link to dashboard and remove Home from header.
- Move Admin link into account menu below Profile.
- Add optional SQLite support for local development with driver config and migrations.
- Make seeds SQLite-compatible by switching to INSERT OR IGNORE.
- Rename uploads page to profile and relabel uploads section as My Uploads.
- Add My Uploads list to profile page.
- Switch to full-width layout with sidebar-based brand and full-height sidebar.
- Add sidebar icons and collapsible sidebar toggle.
- Add sidebar separators, theme toggle, and tooltips for collapsed mode.
- Style sidebar theme toggle as a switch control.
- Allow CDN fonts/styles in CSP and load theme bootstrap script externally.
- Make brand logo color follow theme variables.
- Make theme toggle work without Alpine.
- Hide sidebar and collapse toggle when logged out.
- Inline brand SVG so it inherits theme color.
- Make sidebar collapse toggle work without Alpine and persist state.
- Render sidebar tooltips via JS so they aren't clipped.
- Add notifications bell with unread dot in header.
- Improve theme toggle alignment in sidebar.
- Switch global font to Inter.
- Add configurable app name for visible branding.
- Add privacy, terms, and support pages.
- Add workspaces, memberships, and invite flow with workspace roles.
- Add user settings with profile updates and notification preferences.
- Move profile editing into the profile page.
- Scope admin users list to the current workspace.
- Allow inline workspace renaming with audit logging.
- Filter audit logs to workspaces where the admin has access.
- Create or attach a workspace on signup/login and enforce workspace-required routes.
- Prefill invited email on signup and enforce matching invite addresses.
- Store workspace IDs on audit logs for faster scoped queries.
- Add Workspaces/Team Members tabs on the Workspaces page.
- Rename Workspaces page to Teams and move it to `/teams`.
- Add resend invite action for pending team invites.
- Add in-app and email notifications with batched digest dispatch.
- Add date range and action filters for audit logs.
- Add pagination to the audit log table.
- Rename workspace Admin role to Workspace Admin and global Admin role to Super Admin.
- Rename workspace Owner/Member roles to Workspace Owner/Workspace Member.
- Split admin routes into `/workspace-admin` and `/super-admin`.
- Move roles/permissions/user role assignment to Super Admin navigation.
- Add password change form to the profile page.
- Add account deactivation from the profile page with inactive login block.
- Add Super Admin sections for analytics, usage, and site settings placeholders.
- Align admin page headers with tab navigation layout.
- Show roles table in Super Admin access control settings.
- Add access control tabs in Super Admin site settings with User Roles, Permissions, and Roles.
- Remove legacy RBAC views after consolidating access control.
- Add search, role filtering, and pagination for User Roles in Super Admin settings.
- Add deactivate/reactivate actions for users in Super Admin access control.
- Add search, filtering, and pagination for Teams members and workspaces.
- Add analytics placeholder KPIs, charts, and future data source callouts.
- Make Super Admin default route land on Analytics.
- Add optional footer build identifier from `THRIFTSTACK_BUILD_ID`.
- Populate `THRIFTSTACK_BUILD_ID` during deploy from `git describe`.
- Add billing plans, subscriptions, and webhook scaffolding with provider verification.
- Add Super Admin tabs for Billing Plans and Payment Gateways.
- Move billing plan management to Super Admin Billing Plans.
- Restrict Billing page access to Workspace Owners.
- Allow configurable billing owner roles via `THRIFTSTACK_BILLING_OWNER_ROLES`.
- Allow Super Admins to access `/super-admin` routes without workspace membership.
- Add billing permission to control access to billing pages.
- Remove app roles and replace with system access flags (`users.is_system_admin`, `users.is_system_staff`).
- Squash database migrations into a single schema file.
- Split permissions into workspace permissions and system access flags.
- Move user access management into the Super Admin usage section.
- Rename middleware to RequireWorkspaceRole for clarity.
- Add workspace roles/permissions tabs in Super Admin Access Control.
- Add workspace roles/permissions management for Super Admin settings.
- Gate billing access with workspace-level billing permission.
- Add app-level billing.admin permission for plans and payment gateways.
- Move billing plan create/edit forms into a modal with edit action.
- Add gateway tabs on Super Admin payment gateways page.
- Persist payment gateway settings per provider in the database.
- Add enable/disable control per payment gateway tab.
- Add disabled gateway banner with enable button per provider.
- Add setup help panels per payment gateway tab.
- Show webhook URLs per payment gateway tab.
- Add copy button for webhook URLs.
- Fix MySQL schema and queries to escape the plans interval column.
- Rename plan interval column to duration.
- Label workspace-related roles as Workspace Roles in UI and docs.
- Rename workspace role column to `workspace_role` in memberships/invites.
- Rename Global analytics/usage labels to App analytics/usage.
- Clarify app vs workspace role/permission scope in docs.
- Add hosted checkout wiring for Stripe, Razorpay, PayPal, and Lemon Squeezy with pending subscriptions and provider selection rules.
- Store workspace roles as enums in the database (MySQL) with SQLite checks.
- Remove app permissions from the database and gate app access via system access flags.
- Fallback to local `git describe` for the footer build identifier when unset.
- Add AI credits to plans and support top-up purchases with a new credits section on Billing.
- Add workspace credit balance + ledger with credit grants for subscriptions and top-ups.
- Show workspace AI credit balance on the Billing page.
- Expire top-up credits after 365 days via a daily cron job.
- Add `scripts/daily.php` to run all daily tasks (digests + credit expiry).
- Ensure subscription provider is updated when switching payment gateways.
- Document how to add a new billing provider.
- Add Dodo Payments and Paddle provider integrations with hosted checkout support.
- Add billing schema update migration to backfill missing plan/subscription columns.
- Add credit consumption API at `POST /api/credits/consume` with atomic balance updates and ledger metadata.
  - Request: `credits` (int), `usage_type` (string `[a-z0-9._-]`), optional `metadata` (JSON string).
  - Success: `{"ok":true,"balance_after":120}` (200).
  - Errors: `invalid_usage_type` (422), `insufficient_credits` (409).
- Add API tokens with bearer auth middleware, workspace-scoped token CRUD, and settings page UI.
- Document API Bearer authentication and credit scopes in `docs/api/AUTHENTICATION.md`.
- Add workspace credit limits with daily/monthly tracking, Redis-backed rate limiter, and alert script.
- Add credit limits settings page and enforce limits on credit consumption with 429 responses.
- Add Workspace Admin credits analytics with trend charts, usage breakdown, KPIs, and CSV export.
- Add Super Admin financial analytics with MRR, top-up revenue, churn, and LTV metrics.
  - MRR = sum(active subscriptions) with annual plans divided by 12.
  - Top-up revenue = sum(ai_credit_purchases.amount_cents where status=paid) by month.
  - Churn rate = cancelled last 30 days / (active + cancelled last 30 days).
  - LTV = average subscription lifetime (months) Ã— ARPU.
- Add workspace report preferences with weekly/monthly digest configuration and recipient lists.
- Add workspace settings storage with JSON payloads for report preferences.
- Add scheduled workspace digest emails (weekly/monthly) with credit usage, depletion forecasts, top categories, and cost breakdown summaries.
- Add Super Admin credit analytics with usage segments, heatmaps, usage type trends, anomaly detection, and drill-down table.
- Add spending velocity alerts for System Admins with configurable thresholds and daily checks.
- Add Workspace Admin credit analytics with segments, heatmaps, anomaly detection, drill-down, and velocity alerts.
